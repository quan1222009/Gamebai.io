<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Game Bài Sâm Lốc</title>
    <style>
        /* CSS tương tự phiên bản trước (Tạo bàn chơi, 4 vị trí, card 3D) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1a202c; color: #e2e8f0; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow: hidden; box-sizing: border-box; }
        .container { width: 100%; max-width: 1200px; margin: 20px auto; display: flex; flex-direction: column; align-items: center; gap: 20px; position: relative; }
        #user-info, #status-message { background-color: #2d3748; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #game-area { position: relative; width: 90vmin; height: 90vmin; max-width: 800px; max-height: 800px; background-color: #3b8273; border-radius: 50%; box-shadow: 0 0 0 20px #4a5568, inset 0 0 20px rgba(0,0,0,0.5); margin-top: 20px; }
        #game-area::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 50%; background: radial-gradient(circle at center, rgba(255, 255, 200, 0.1) 0%, rgba(0,0,0,0.5) 70%, rgba(0,0,0,0.8) 100%); pointer-events: none; }
        #game-title { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #2d3748; font-size: 3em; font-weight: 900; text-shadow: 2px 2px 5px rgba(0,0,0,0.5); z-index: 1; }

        /* Vị trí người chơi */
        .player-seat { position: absolute; width: 80px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .player-seat.top { top: 5%; left: 50%; transform: translateX(-50%); }
        .player-seat.left { left: 5%; top: 50%; transform: translateY(-50%) rotate(90deg); }
        .player-seat.right { right: 5%; top: 50%; transform: translateY(-50%) rotate(-90deg); }
        .player-seat.bottom { bottom: 0; left: 50%; transform: translateX(-50%); }

        /* Card và Hand */
        .card-hand { display: flex; justify-content: center; flex-wrap: nowrap; transform-style: preserve-3d; margin-top: 20px; }
        .card { width: 60px; height: 90px; background-color: white; border: 1px solid #333; border-radius: 6px; position: relative; margin: 0 -15px; transition: transform 0.2s ease; cursor: pointer; transform: rotateX(15deg) rotateY(0deg) rotateZ(0deg); }
        .card.selected { transform: translateY(-25px) rotateX(5deg); border-color: #48bb78; box-shadow: 0 0 15px #48bb78; z-index: 15; }

        #player-hand-area { position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; width: 90%; z-index: 20; }
        
        /* --- Nút điều khiển chung và hành động --- */
        .control-panel { 
            width: 100%; max-width: 900px; display: flex; justify-content: space-around; 
            margin-bottom: 20px; 
        }
        .control-group, #action-buttons { 
            display: flex; gap: 10px; 
            background-color: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px;
        }

        #action-buttons { 
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); z-index: 25;
        }

        .control-panel button, #action-buttons button, .control-panel input {
            padding: 10px 15px; font-size: 14px; border: none; border-radius: 5px; cursor: pointer;
            transition: background-color 0.2s, transform 0.1s; color: white;
        }
        
        .btn-green { background-color: #48bb78; }
        .btn-green:hover { background-color: #38a169; }
        .btn-red { background-color: #e53e3e; }
        .btn-red:hover { background-color: #c53030; }
        .btn-blue { background-color: #4299e1; }
        .btn-blue:hover { background-color: #3182ce; }
        .btn-default { background-color: #2d3748; }
        .btn-default:hover { background-color: #1a202c; }

        .control-panel input {
            background-color: #4a5568; color: white; border: 1px solid #63b3ed;
        }
        
        /* Nội dung quân bài (cần copy từ phiên bản trước) */
        .card.C, .card.R { color: red; } 
        .card.T, .card.B { color: black; } 
        .card .rank-top, .card .rank-bottom { font-size: 0.8em; }
        .card .suit-center { font-size: 1.5em; line-height: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Giao Diện Game Bài Sâm Lốc</h1>
        
        <p id="user-info">ID của bạn: <span id="my-user-id">Đang tải...</span></p>
        <p id="status-message">Chọn game để bắt đầu.</p>

        <div class="control-panel">
            
            <div class="control-group">
                <button class="btn-green" onclick="joinQueue('sam')">Ghép Nhanh (Người)</button>
                <button class="btn-blue" onclick="joinBotGame('sam')">Chơi với BOT</button>
            </div>

            <div class="control-group">
                <button class="btn-green" onclick="createPrivateRoom('sam')">Tạo Phòng SOLO</button>
                <input type="text" id="private-room-code-input" placeholder="Mã phòng Solo">
                <button class="btn-blue" onclick="joinPrivateRoom()">Vào Phòng SOLO</button>
            </div>
            
            <div class="control-group">
                <input type="text" id="friend-id-input" placeholder="ID (12 số) để kết bạn">
                <button class="btn-default" onclick="addFriendById()">Kết bạn</button>
            </div>
        </div>
        
        <div id="game-area">
            <div id="game-title">SÂM LỐC</div>
            
            <div class="player-seat top"><div class="player-info">TOP (9 Cards)</div></div>
            <div class="player-seat left"><div class="player-info">LEFT (10 Cards)</div></div>
            <div class="player-seat right"><div class="player-info">RIGHT (8 Cards)</div></div>
            
            <div id="played-cards-area">
                <div id="played-cards" class="card-hand"></div>
            </div>
            
            <div id="action-buttons">
                <button id="btn-pass" class="btn-red" onclick="passTurn()">Bỏ Lượt</button>
                <button id="btn-play" class="btn-green" onclick="playSelectedCards()">Đánh</button>
                <button id="btn-bao-sam" class="btn-green" onclick="baoSam()">Báo Sâm</button>
                <button id="btn-huy-sam" class="btn-default" onclick="cancelSam()">Hủy Sâm</button>
            </div>

            <div id="player-hand-area" class="player-seat bottom">
                <div id="player-hand" class="card-hand"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const myUserIdSpan = document.getElementById('my-user-id');
        const statusMessage = document.getElementById('status-message');
        const playerHandDiv = document.getElementById('player-hand');
        const friendIdInput = document.getElementById('friend-id-input');
        
        let selectedCards = []; 
        let currentGameState = null;

        // --- Hàm Utility: Map card object to HTML card element (GIỮ NGUYÊN) ---
        function createCardElement(card) {
            const cardEl = document.createElement('div');
            cardEl.className = `card ${card.suit}`; 
            cardEl.dataset.rank = card.rank;
            cardEl.dataset.suit = card.suit;
            cardEl.dataset.value = card.value;
            cardEl.dataset.suitValue = card.suit_value;
            
            const suitChar = card.suit === 'C' ? '♥' : card.suit === 'R' ? '♦' : card.suit === 'T' ? '♣' : '♠';

            cardEl.innerHTML = `
                <div class="rank-top">${card.rank}</div>
                <div class="suit-center">${suitChar}</div>
                <div class="rank-bottom">${card.rank}</div>
            `;
            cardEl.onclick = () => toggleCardSelection(card, cardEl);
            return cardEl;
        }

        // --- CÁC HÀM GỬI LỆNH MỚI (CHƠI BOT, KẾT BẠN) ---

        function joinBotGame(gameType) {
            statusMessage.textContent = `Đang tạo phòng chơi với BOT (${gameType})...`;
            socket.emit('join_bot_game', gameType);
        }

        function addFriendById() {
            const targetId = friendIdInput.value.trim();
            if (targetId.length >= 10 && targetId.length <= 12) {
                socket.emit('add_friend_by_id', targetId);
            } else {
                alert('ID bạn bè phải có từ 10 đến 12 chữ số.');
            }
        }
        
        // --- CÁC HÀM GỬI LỆNH CŨ (ĐÁNH BÀI, PASS, QUEUE, SOLO) ---
        function toggleCardSelection(card, cardEl) { /* ... */ }
        function joinQueue(gameType) { /* ... */ socket.emit('join_queue', gameType); }
        function createPrivateRoom(gameType) { /* ... */ socket.emit('create_private_room', gameType); }
        function joinPrivateRoom() { /* ... */ }
        function playSelectedCards() { /* ... */ }
        function passTurn() { /* ... */ }
        function baoSam() { /* ... */ }
        function cancelSam() { alert('Chức năng Hủy Sâm chưa được lập trình.'); }


        // --- SOCKET.IO EVENTS (Cần đảm bảo tất cả các sự kiện cũ đều có) ---

        socket.on('connect', () => { console.log('Connected to server'); });
        socket.on('my_user_id', (userId) => { 
            myUserIdSpan.textContent = userId; 
            socket.data.userId = userId; 
        });
        socket.on('friend_status', (message) => { // Xử lý thông báo kết bạn
            statusMessage.textContent = message; 
        });
        
        socket.on('bot_action', (data) => {
            if (data.action === 'pass') {
                 statusMessage.textContent = `BOT ${data.userId} đã BỎ LƯỢT.`;
            } else if (data.action === 'play') {
                 statusMessage.textContent = `BOT ${data.userId} đã ĐÁNH bài.`;
            }
        });

        // Xử lý game_state_update
        socket.on('game_state_update', (state) => {
            // (Cần viết lại toàn bộ logic này để hiển thị đúng 4 người chơi và trạng thái của họ)
            
            // Tạm thời chỉ cập nhật bài trên tay:
            const userId = socket.data.userId;
            const currentPlayerHand = state.cards[userId] || [];
            playerHandDiv.innerHTML = ''; 
            currentPlayerHand.forEach(card => {
                playerHandDiv.appendChild(createCardElement(card));
            });
            
            // ... (Cập nhật bài đã đánh, lượt chơi, trạng thái nút bấm) ...
        });
        
        socket.on('error', (message) => { alert('Lỗi: ' + message); });

    </script>
</body>
</html>
